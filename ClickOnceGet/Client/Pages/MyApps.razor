@page "/myapps"
@attribute [Authorize]
@inject ISnackbar Snackbar
@inject HttpClient HttpClient
@inject IDialogService Dialog
@inject NavigationManager NavigationManager
@inject IClickOnceAppInfoProvider ClickOnceAppInfoProvider

<MudContainer>
    <h2>Manage Applications</h2>
</MudContainer>

<div>
    @foreach (var app in Apps)
    {
        <ClickOnceApp @key="app.Name" AppInfo="app" Manage="true" OnClickEdit="OnClickEdit" OnClickDelete="OnClickDelete" />
    }
</div>

<div class="padding"></div>

<div>
    <MudFab Link="myapps/upload" Color="Color.Primary" Icon="@Icons.Material.Upgrade" Class="upload-my-app" />
</div>

@code {
    private List<ClickOnceAppInfo> Apps = new List<ClickOnceAppInfo>();

    protected override async Task OnInitializedAsync()
    {
        var myApps = await this.ClickOnceAppInfoProvider.GetOwnedAppsAsync();
        this.Apps.AddRange(myApps);
    }

    private void OnClickEdit(ClickOnceAppInfo appInfo)
    {
        NavigationManager.NavigateTo($"myapps/{Uri.EscapeUriString(appInfo.Name)}");
    }

    private async Task OnClickDelete(ClickOnceAppInfo appInfo)
    {
        var param = new DialogParameters();
        param.Add("Message", $"This operation delete the \"{appInfo.Title}\" application from this site. This operation cannot rollback. Are you sure?");
        var response = await this.Dialog.Show<ConfirmDialog>(title: "Delete the application", param).Result;
        if (response.Cancelled) return;

        await this.HttpClient.DeleteAsync($"api/myapps/{Uri.EscapeUriString(appInfo.Name)}");

        this.Apps.Remove(appInfo);

        this.Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        this.Snackbar.Default($"The \"{appInfo.Title}\" application was deleted.");
    }
}