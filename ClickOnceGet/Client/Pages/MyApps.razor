@page "/myapps"
@attribute [Authorize]
@inject IClickOnceAppInfoProvider ClickOnceAppInfoProvider
@inject IDialogService Dialog
@inject ISnackbar Snackbar
@inject HttpClient Http
@inject NavigationManager NavigationManager

<MudContainer>
    <h2>Manage Applications</h2>
</MudContainer>

<div>
    @foreach (var app in _Apps)
    {
        <ClickOnceApp @key="app.Name" AppInfo="app" Manage="true" OnClickEdit="OnClickEdit" OnClickDelete="OnClickDelete" />
    }
</div>

<div class="padding"></div>

<div>
    <MudFab Link="myapps/upload" Color="Color.Primary" Icon="@Icons.Material.Upgrade" Class="upload-my-app" />
</div>

@code {
    private List<ClickOnceAppInfo> _Apps = new List<ClickOnceAppInfo>();

    protected override async Task OnInitializedAsync()
    {
        var myApps = await ClickOnceAppInfoProvider.GetOwnedAppsAsync();
        _Apps.AddRange(myApps);
    }

    private void OnClickEdit(ClickOnceAppInfo appInfo)
    {
        NavigationManager.NavigateTo($"myapps/{Uri.EscapeUriString(appInfo.Name)}");
    }

    private async Task OnClickDelete(ClickOnceAppInfo appInfo)
    {
        var param = new DialogParameters();
        param.Add("Message", $"This operation delete the \"{appInfo.Title}\" application from this site. This operation cannot rollback. Are you sure?");
        var response = await Dialog.Show<ConfirmDialog>(title: "Delete the application", param).Result;
        if (response.Cancelled) return;

        await Http.DeleteAsync($"api/myapps/{Uri.EscapeUriString(appInfo.Name)}");

        _Apps.Remove(appInfo);

        Snackbar.Configuration.PositionClass = Defaults.Classes.Position.BottomRight;
        Snackbar.Default($"The \"{appInfo.Title}\" application was deleted.");
    }
}